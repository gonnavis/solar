


<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

	<script type="text/javascript" src="/test/lib/jquery-2.1.4.js"></script>
	<script type="text/javascript">
		var jq=jQuery.noConflict();
	</script>

	<!-- <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_j56o52g1hhq6w29.css"> -->
	<style type="text/css">

		html,body{width: 100%;height: 100%;border:0;padding: 0;margin:0;position: relative;}
		.main{width: 1200px;height: 800px;}
		.main{position: fixed;background: url(bg.jpg) no-repeat;background-size:100% 100%;}
		.trape_wrap{position: fixed;left: 0;top:0;width: 100%;height: 100%;pointer-events: none;}
		.trape{position: absolute;top:0;left: 0;overflow: visible;width: 0;height: 0;pointer-events: all;}
		svg{overflow: visible;position: fixed;left: 0;top:0;width: 100%;height: 100%;cursor: pointer;}
		.dot{cursor: ew-resize;}
		.trape .trape_fill{pointer-events: all;fill:rgba(190,110,70,.5);}
		.trape.act .trape_fill{fill:rgba(255,100,0,.5);}
		.label{    position: absolute; width: 200px; height: 50px; border: solid 2px; background: white; top: 0; left: 0; line-height: 20px; text-align: center; user-select: none; font-size: 12px; padding-top: 10px;pointer-events: none;user-select:none;}
		.btns{position: absolute; width: 900px; height: 90px; top: 0; left: 230px; line-height: 20px; text-align: center; user-select: none; font-size: 12px; padding-top: 10px;pointer-events: none;user-select:none;text-align: left;}
		.btn{border: solid 2px; background: white;padding:0 10px;line-height: 45px; display: inline-block;cursor: pointer;pointer-events: all;vertical-align: middle;}
		/*.arrows{display: none;}*/
		.arrow{fill: red;display: none;}
		.arrow_up{ transform: translate(-32px,-70px) scale(.06); }
		.arrow_down{ transform: rotate(180deg) translate(-32px,-70px) scale(.06); }
		.arrow_left{ transform: rotate(-90deg) translate(-32px,-70px) scale(.06); }
		.arrow_right{ transform: rotate(90deg) translate(-32px,-70px) scale(.06); }
		line.bottom{cursor: ns-resize;}
		.mask{position: absolute;width: 100%;height: 100%;pointer-events: all;cursor: wait;}
		.solars{pointer-events: none;}
	</style>

</head>
<body>

<div class="trape_wrap proto" style="display: none;">
	<div class="mask"></div>
	<svg>
		<g class="trape">
			<polygon class="trape_fill" points="" style="" />
			<g class="solars"></g>
			<line class="top" stroke-width="3" stroke="red"></line>
			<line class="right" stroke-width="1" stroke="orange"></line>
			<line class="bottom" stroke-width="3" stroke="red"></line>
			<line class="left" stroke-width="1" stroke="orange"></line>
			<circle class="dot d0" r="4" stroke="red" ></circle>
			<circle class="dot d1" r="4" ></circle>
			<circle class="dot d2" r="4" ></circle>
			<circle class="dot d3" r="4" ></circle>
			<g class="arrows">
				<path class="arrow arrow_up" d="M416.977 392.484l-111.645 39.508c-32.233 11.407-44.238-3.146-25.347-33.026l206.043-325.89c18.663-29.518 49.519-29.879 68.408 0l206.043 325.89c18.663 29.519 7.542 44.664-25.347 33.025l-111.645-39.508-83.511 524.074c-10.906 68.435-28.568 68.536-39.49 0l-83.511-524.075z"></path>
				<path class="arrow arrow_down" d="M416.977 392.484l-111.645 39.508c-32.233 11.407-44.238-3.146-25.347-33.026l206.043-325.89c18.663-29.518 49.519-29.879 68.408 0l206.043 325.89c18.663 29.519 7.542 44.664-25.347 33.025l-111.645-39.508-83.511 524.074c-10.906 68.435-28.568 68.536-39.49 0l-83.511-524.075z"></path>
				<path class="arrow arrow_left" d="M416.977 392.484l-111.645 39.508c-32.233 11.407-44.238-3.146-25.347-33.026l206.043-325.89c18.663-29.518 49.519-29.879 68.408 0l206.043 325.89c18.663 29.519 7.542 44.664-25.347 33.025l-111.645-39.508-83.511 524.074c-10.906 68.435-28.568 68.536-39.49 0l-83.511-524.075z"></path>
				<path class="arrow arrow_right" d="M416.977 392.484l-111.645 39.508c-32.233 11.407-44.238-3.146-25.347-33.026l206.043-325.89c18.663-29.518 49.519-29.879 68.408 0l206.043 325.89c18.663 29.519 7.542 44.664-25.347 33.025l-111.645-39.508-83.511 524.074c-10.906 68.435-28.568 68.536-39.49 0l-83.511-524.075z"></path>
			</g>
		</g>
	</svg>
</div>

<div class="main">
	<div class="label">
		双击添加新选区。红边为平行边。<br>
		x:<span class="x"></span> y:<span class="y"></span>
	</div>
</div>

<div class="btns">
	<!-- <div class="btn calc_solars">计算太阳能板数量</div> -->
	<div class="btn ">太阳能板总数： <span class="solars_total"></span></div>
	<div class="btn rotate_left iconfont icon-zuoxuanzhuan90" style="font-size: 26px;"></div>
	<div class="btn rotate_right iconfont icon-youxuanzhuan90" style="font-size: 26px;"></div>
	<div class="btn delete" >删除</div>
	<div class="btn set_lean" style="display: none;">设置倾斜方向</div>
</div>


<script type="text/javascript">

	var log=console.log;

	var gv={};
	gv.radian_to_degree=function(radian){
		return radian*180/Math.PI;
	}
	gv.get_distance=function(a,b){
		b=b||{x:0,y:0};
		return Math.sqrt(
				Math.pow((a.x-b.x),2)
				+Math.pow((a.y-b.y),2)
			)
	}
</script>

<script type="text/javascript">

	function Trape(parent,option){
		var s=this;
		Trape.prototype.trapes.push(s);
		var option=option||{};
		s.dom=jq('.proto.trape_wrap').clone().removeClass('proto').show();
		s.x=option.x||300;
		s.y=option.y||300;
		s.d0=option.d0||{x:0,y:0};
		s.d1=option.d1||{x:100,y:0};
		s.d2=option.d2||{x:120,y:80};
		s.d3=option.d3||{x:-20,y:80};
		s.act_dot_index;
		s.radian=0;
		s.degree=0;
		s.precison=6;
		s.init(parent);
	}

	Trape.prototype={
		trapes:[],
		init:function(parent){
			var s=this;

			jq(parent).append(s.dom);

			s.draw();

			s.set_act();

			s.bind_dots();
			s.bind_polygon();
			s.bind_bottom_line();
			s.bind_mask();
		},
		get_data:function(){
			var s=this;

			s.height=s.d3.y-s.d0.y;

			s.trape_top_width=gv.get_distance(s.d0,s.d1)
			s.trape_bottom_width=gv.get_distance(s.d3,s.d2)

			for(var i=0;i<4;i++){
				s['d'+i].lx=Math.cos(s.get_dot_radian(s['d'+i])+s.radian)
					*gv.get_distance(s['d'+i]);
				s['d'+i].ly=-(Math.sin(s.get_dot_radian(s['d'+i])+s.radian)
					*gv.get_distance(s['d'+i]));

				s['d'+i].wx=s.x+s['d'+i].lx;
				s['d'+i].wy=s.y+s['d'+i].ly;
			}
		},
		draw:function(){
			var s=this;
			s.get_data();
			s.dom.find('.trape').css('transform','translate('+s.x+'px,'+s.y+'px) rotate('+-s.radian+'rad)');
			// s.dom.find('.trape').css('transform','translate('+s.x+'px,'+s.y+'px) rotate(60deg)');
			s.draw_polygon();
			s.draw_dots();
			s.draw_solars();
		},
		draw_polygon:function(){
			var s=this;
			var points='';

			for(var i=0;i<4;i++){
				points+=(s['d'+i].x)+','+(s['d'+i].y)+' ';
			}
			s.dom.find('.trape_fill').attr('points',points);

			var top_line=s.dom.find('.top');
			top_line.attr('x1',s.d0.x);
			top_line.attr('y1',s.d0.y);
			top_line.attr('x2',s.d1.x);
			top_line.attr('y2',s.d1.y);

			var right_line=s.dom.find('.right');
			right_line.attr('x1',s.d1.x);
			right_line.attr('y1',s.d1.y);
			right_line.attr('x2',s.d2.x);
			right_line.attr('y2',s.d2.y);

			var bottom_line=s.dom.find('.bottom');
			bottom_line.attr('x1',s.d2.x);
			bottom_line.attr('y1',s.d2.y);
			bottom_line.attr('x2',s.d3.x);
			bottom_line.attr('y2',s.d3.y);

			var left_line=s.dom.find('.left');
			left_line.attr('x1',s.d3.x);
			left_line.attr('y1',s.d3.y);
			left_line.attr('x2',s.d0.x);
			left_line.attr('y2',s.d0.y);
		},
		draw_dots:function(){
			var s=this;
			s.dom.find('.dot').eq(0).attr('cx',s.d0.x)
			s.dom.find('.dot').eq(0).attr('cy',s.d0.y)
			s.dom.find('.dot').eq(1).attr('cx',s.d1.x)
			s.dom.find('.dot').eq(1).attr('cy',s.d1.y)
			s.dom.find('.dot').eq(2).attr('cx',s.d2.x)
			s.dom.find('.dot').eq(2).attr('cy',s.d2.y)
			s.dom.find('.dot').eq(3).attr('cx',s.d3.x)
			s.dom.find('.dot').eq(3).attr('cy',s.d3.y)
		},
		bind_dots:function(){
			var s=this;

			s.dom.find('.dot').each(function(i,elem){

				elem=jq(elem);
				var startX = 0, startY = 0, x = 0, y = 0;

				var origin_width=0;
				var origin_x=0

				elem.on('mousedown', function(e) {
					e.preventDefault();
					startX = e.pageX;
					startY = e.pageY;

					s.act_dot_index=i;
					if(i==0){
						origin_width=s.trape_top_width;
						origin_x=s.d0.x;
					}
					else if(i==1){
						origin_width=s.trape_top_width;
						origin_x=s.d1.x;
					}
					else if(i==2){
						origin_width=s.trape_bottom_width;
						origin_x=s.d2.x;
					}
					else if(i==3){
						origin_width=s.trape_bottom_width;
						origin_x=s.d3.x;
					}

					jq(document).on('mousemove', mousemove);
					jq(document).on('mouseup', mouseup);
					// s.dom.find('.solars').hide();
					s.set_act();
				});

				function mousemove(e) {

					// console.log('mousemove i: '+i);
					if(i==0){
						var mx=e.pageX-(s.d1.wx);
						var my=-(e.pageY-s.d1.wy);

						var x1=-origin_width/Math.cos(s.radian);
						// var b=s.mod_radian(Math.PI/2-s.radian+Math.PI);
						var b=Math.PI/2-s.radian;
						var y1=Math.tan(b)*x1;
						var y2=y1-my;
						var x2=x1*y2/y1;
						var h=mx-x2;
						var r=Math.cos(s.radian)*h;
						s.d0.x=origin_x+r;

						if(s.d0.x>s.d1.x){
							s.d0.x=s.d1.x-4;
						}
					}
					else if(i==1){
						var mx=e.pageX-s.d0.wx;
						var my=-(e.pageY-s.d0.wy);

						var x1=origin_width/Math.cos(s.radian);
						var b=Math.PI/2-s.radian;
						var y1=Math.tan(b)*x1;
						var y2=y1-my;
						var x2=x1*y2/y1;
						var h=mx-x2;
						var r=Math.cos(s.radian)*h;
						s.d1.x=origin_x+r;

						if(s.d1.x<s.d0.x){
							s.d1.x=s.d0.x+4;
						}
					}
					else if(i==2){
						var mx=e.pageX-(s.d3.wx);
						var my=-(e.pageY-s.d3.wy);

						var x1=origin_width/Math.cos(s.radian);
						var b=Math.PI/2-s.radian;
						var y1=Math.tan(b)*x1;
						var y2=y1-my;
						var x2=x1*y2/y1;
						var h=mx-x2;
						var r=Math.cos(s.radian)*h;
						s.d2.x=origin_x+r;

						if(s.d2.x<s.d3.x){
							s.d2.x=s.d3.x+4;
						}
					}
					else if(i==3){
						var mx=e.pageX-(s.d2.wx);
						var my=-(e.pageY-s.d2.wy);

						var x1=-origin_width/Math.cos(s.radian);
						// var b=s.mod_radian(Math.PI/2-s.radian+Math.PI);
						var b=Math.PI/2-s.radian;
						var y1=Math.tan(b)*x1;
						var y2=y1-my;
						var x2=x1*y2/y1;
						var h=mx-x2;
						var r=Math.cos(s.radian)*h;
						s.d3.x=origin_x+r;

						if(s.d3.x>s.d2.x){
							s.d3.x=s.d2.x-4;
						}
					}

					s.draw();
				}

				function mouseup() {

					if(s.act_dot_index==0){
						var drag_distance=-(s.d0.x);
						for(var i=0;i<4;i++){
							s['d'+i].x+=drag_distance;
						}
						s.x-=Math.cos(s.radian)*drag_distance;
						s.y+=Math.sin(s.radian)*drag_distance;
						s.draw();
					}

					jq(document).off('mousemove', mousemove);
					jq(document).off('mouseup', mouseup);
					// s.dom.find('.solars').show();
				}
			})
		},
		bind_polygon:function(){
			var s=this;

			s.dom.find('polygon').each(function(i,elem){

				elem=jq(elem);
				var startX = 0, startY = 0, x = 0, y = 0;

				elem.on('mousedown', function(e) {
					e.preventDefault();
					startX = e.pageX;
					startY = e.pageY;
					jq(document).on('mousemove', mousemove);
					jq(document).on('mouseup', mouseup);
					// s.dom.find('.solars').hide();
					s.set_act();
				});

				function mousemove(e) {
					x = e.pageX - startX;
					y = e.pageY - startY;
					startX = e.pageX;
					startY = e.pageY;

					s.x+=x;
					s.y+=y;

					s.draw();
				}

				function mouseup() {
					jq(document).off('mousemove', mousemove);
					jq(document).off('mouseup', mouseup);
					// s.dom.find('.solars').show();
				}
			})
		},
		bind_bottom_line:function(){
			var s=this;

			s.dom.find('line.bottom').each(function(i,elem){

				elem=jq(elem);
				var startX = 0, startY = 0, x = 0, y = 0;

				var origin_height=0;

				elem.on('mousedown', function(e) {
					e.preventDefault();
					startX = e.pageX;
					startY = e.pageY;

					origin_height=s.d3.y;

					jq(document).on('mousemove', mousemove);
					jq(document).on('mouseup', mouseup);
				});

				function mousemove(e) {

					var mx=e.pageX-(startX);
					var my=-(e.pageY-startY);

					var a=s.radian-(Math.PI/2);
					var o=Math.tan(a)*my;
					var p=o+mx;
					var r=Math.cos(a)*p;
					s.d2.y=origin_height+r;
					s.d3.y=origin_height+r;

					if(s.d2.y<4){
						s.d2.y=4;
						s.d3.y=4;
					}

					s.draw();
				}

				function mouseup() {
					jq(document).off('mousemove', mousemove);
					jq(document).off('mouseup', mouseup);
				}
			})
		},
		bind_mask:function(){
			var s=this;

			s.dom.find('.mask').each(function(i,elem){

				elem=jq(elem);
				var startX = 0, startY = 0, x = 0, y = 0;

				elem.on('mousedown', function(e) {
					// log(1);
					e.preventDefault();
					startX = e.pageX;
					startY = e.pageY;
					jq(document).on('mousemove', mousemove);
					jq(document).on('mouseup', mouseup);
				});

				function mousemove(e) {
					// log(2);
					x = e.pageX - startX;
					y = e.pageY - startY;
					startX = e.pageX;
					startY = e.pageY;

					s.rotate(-x/300);
				}

				function mouseup() {
					jq(document).off('mousemove', mousemove);
					jq(document).off('mouseup', mouseup);
				}
			})
		},
		draw_solars:function(){
			var s=this;

			// init

				var s=s;

				s.solars=[];

				s.solar_width=30;
				s.solar_height=15;

				s.rect={};
				s.rect.left=Math.min(s.d0.x,s.d3.x);
				s.rect.right=Math.max(s.d1.x,s.d2.x);
				s.rect.width=s.rect.right-s.rect.left;
				s.rect.height=s.d3.y;

			// add all solars
				var solars_bottom=0;
				while(solars_bottom+s.solar_height<s.rect.height){
					var solars_right=s.rect.left;
					while(solars_right+s.solar_width<s.rect.right){
						s.solars.push({
							x:solars_right,
							y:solars_bottom,
						})
						solars_right+=s.solar_width;
					}
					solars_bottom+=s.solar_height;
				}

			// delete overflow solars
				for(var i=0;i<s.solars.length;i++){
					var solar=s.solars[i];

					// debugger;
					var left_most;
					if(s.d0.x>=s.d3.x){
						var x=s.d0.x-s.d3.x;
						var x1=x*solar.y/s.height;
						left_most=-x1;
						if(solar.x<left_most){
							solar.is_delete=true;
							continue;
						}
					}
					else{
						var x=s.d3.x-s.d0.x;
						var x1=x*(solar.y+s.solar_height)/s.height;
						left_most=x1;
						if(solar.x<left_most){
							solar.is_delete=true;
							continue;
						}
					}

					var right_most;
					if(s.d2.x>=s.d1.x){
						var x=s.d2.x-s.d1.x;
						var x1=x*solar.y/s.height;
						right_most=s.d1.x+x1;
						if(solar.x+s.solar_width>right_most){
							solar.is_delete=true;
							continue;
						}
					}
					else{
						var x=s.d1.x-s.d2.x;
						var x1=x*(solar.y+s.solar_height)/s.height;
						right_most=s.d1.x-x1;
						if(solar.x+s.solar_width>right_most){
							solar.is_delete=true;
							continue;
						}
					}
				}
				for(var i=0;i<s.solars.length;){
					var solar=s.solars[i];

					if(solar.is_delete){
						s.solars.splice(i,1);
					}
					else{
						i++;
					}
				}

			// count
				var solars_total=0;
				for(var i=0;i<Trape.prototype.trapes.length;i++){
					var trape=Trape.prototype.trapes[i];
					solars_total+=trape.solars.length;
				}
				jq('.solars_total').html(solars_total);

			// draw
				s.dom.find('.solar').remove();
				for(var i=0;i<s.solars.length;i++){
					var solar=s.solars[i];

					var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'polygon'); //Create a path in SVG's namespace
					newElement.setAttribute("class",'solar');
					newElement.setAttribute("points",
								solar.x+','+solar.y
								+' '+(solar.x+s.solar_width)+','+solar.y
								+' '+(solar.x+s.solar_width)+','+(solar.y+s.solar_height)
								+' '+solar.x+','+(solar.y+s.solar_height)
							); //Set path's data
					newElement.style.fill = "rgba(0,0,0,.5)"; //Set stroke colour
					newElement.style.stroke = "black"; //Set stroke colour
					newElement.style.strokeWidth = "1"; //Set stroke colour

					s.dom.find('svg g.solars')[0].appendChild(newElement);
					if(s.is_flip){
						s.dom.find('svg g.rotater').css('transform','rotate('+-s.degree+'deg) scaleY(-1)');
					}
					else{
						s.dom.find('svg g.rotater').css('transform','rotate('+-s.degree+'deg)');
					}
				}
		},
		mod_radian:function(radian){
			radian=radian%(2*Math.PI);
			if(radian<0){
				radian=2*Math.PI-radian;
			}
			return radian;
		},
		get_dot_radian:function(dot,origin){
			/* params
				dot: a point
				origin: a point
			*/
			var s=this;
			var radian;
			origin=origin||{x:0,y:0};
			var hypotenuse=gv.get_distance(origin,dot);
			if(hypotenuse==0){
				return 0;
			}
			var opposite=origin.y-dot.y;
			var asin=Math.asin(opposite/hypotenuse);
			radian=asin;
			if(dot.x<origin.x){
				radian=Math.PI-asin;
			}
			if(dot.x>origin.x&&dot.y>origin.y){
				radian=Math.PI*2+asin;
			}
			radian=s.mod_radian(radian);
			return radian;
		},
		set_dot_radian:function(dot,radian,origin){
			/* params
				dot: a point
				origin: a point
			*/
			var s=this;
			origin=origin||{x:0,y:0};
			var hypotenuse=gv.get_distance(dot,origin);
			var opposite=hypotenuse*Math.sin(radian);
			var adjacent=hypotenuse*Math.cos(radian);
			dot.x=adjacent+origin.x;
			dot.y=-opposite+origin.y;
		},
		rotate_dot:function(dot,radian,origin){
			/* params
				origin: point
			*/
			var s=this;
			origin=origin||{x:0,y:0};
			var new_radian=s.get_dot_radian(dot,origin)+radian;
			s.set_dot_radian(dot,new_radian,origin);
		},
		rotate:function(radian){
			var s=this;

			s.radian-=radian;
			s.radian=s.mod_radian(s.radian);

			s.draw();
		},
		refresh_data:function(){
			// var s=this;
			// s.degree=s.get_dot_radian(s.d1);
		},
		set_act:function(){
			var s=this;
			for(var i=0;i<Trape.prototype.trapes.length;i++){
				var trape=Trape.prototype.trapes[i];
				trape.dom.removeClass('act');
			}
			Trape.prototype.trape_act=s;
			s.dom.addClass('act');
		},
		delete:function(){
			var s=this;
			s.dom.remove();
			Trape.prototype.trapes.splice(Trape.prototype.trapes.indexOf(s),1);
		},
		set_lean:function(){
			var s=this;
			s.dom.find('.arrows').removeAttr('display');
		},
	}


</script>

<script type="text/javascript">
	var trape=new Trape('.main',{
		x:636,
		y:270,
		d3:{x:-20,y:80},
	});
	// var trape2=new Trape('.main',{x:270,y:270});

	trape.set_act();
	// trape2.rotate(Math.PI/2);
	// trape2.draw();
	// trape2.draw_solars();

	jq('.btns').dblclick(function(e){
		e.stopPropagation();
	})

	jq('.main').dblclick(function(e){
		new Trape('.main',{
			x:e.pageX,
			y:e.pageY,
		})
	})

	jq(document).mousemove(function(){
		// console.log(trape.radian.toFixed(3)+' '+trape.degree.toFixed(0));
	})

	jq('.calc_solars').click(function(){
		for(var i=0;i<Trape.prototype.trapes.length;i++){
			var trape=Trape.prototype.trapes[i];
			trape.draw_solars();
		}
	})

	jq('.rotate_left').click(function(){
		Trape.prototype.trape_act.rotate(Math.PI/2);
		Trape.prototype.trape_act.draw();
	})

	jq('.rotate_right').click(function(){
		Trape.prototype.trape_act.rotate(-Math.PI/2);
		Trape.prototype.trape_act.draw();
	})

	jq('.delete').click(function(){
		Trape.prototype.trape_act.delete();
	})

	jq('.set_lean').click(function(){
		Trape.prototype.trape_act.set_lean();
	})
</script>

</body>
</html>